![[Pasted image 20260102213338.png]]

[옵시디언 사용법- 이미지 등  첨부파일 깔끔하게 정리하기](https://mokeya2.tistory.com/entry/%EC%98%B5%EC%8B%9C%EB%94%94%EC%96%B8-%EC%82%AC%EC%9A%A9%EB%B2%95-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%93%B1-%EC%B2%A8%EB%B6%80%ED%8C%8C%EC%9D%BC-%EA%B9%94%EB%81%94%ED%95%98%EA%B2%8C-%EC%A0%95%EB%A6%AC%ED%95%98%EA%B8%B0)


---



# 채팅 시스템 개발 가이드

## 1. 프로젝트 개요
- **목적**: 실시간 채팅 시스템 구축 (토이 프로젝트용)
- **개발자 레벨**: 3~4년차 백엔드 개발자
- **핵심 기술**: WebSocket + Redis Pub/Sub

## 2. 기술 스택
```
- Java 17
- Spring Boot 3.2.x
- Spring Web, Spring Data JPA, Spring WebSocket
- Spring Data Redis (Pub/Sub)
- PostgreSQL (영구 저장소)
- Redis (메시지 브로커, 캐싱)
- Gradle
- Lombok


## 3. 개발 단계별 계획

### Phase 1: 기본 기능 (현재 목표) ⭐

1. **엔티티 및 Repository 구축**
    - User, ChatRoom, ChatRoomParticipant, ChatMessage
2. **REST API 구현**
    - 방 목록 조회
    - 방 생성
    - 방 참여
    - 메시지 조회 (페이징)
3. **WebSocket + Redis Pub/Sub 실시간 채팅**
    - WebSocket 설정
    - Redis Pub/Sub 구성
    - 실시간 메시지 송수신

### Phase 2: Redis 캐싱 최적화 (나중)

### Phase 3: 부가 기능 (나중)

### Phase 4: Kafka 마이그레이션 (나중)

**현재는 Phase 1만 집중하며, 한 단계씩 완성하고 진행**

## 4. 데이터베이스 설계

### 엔티티 구조

java

```java
// User (사용자)
- id: Long (PK, Auto Increment)
- username: String (unique, not null, 로그인용)
- nickname: String (not null, 표시용)
- createdAt: LocalDateTime (not null)

// ChatRoom (채팅방)
- id: Long (PK, Auto Increment)
- name: String (not null, 방 제목)
- type: RoomType (enum: PUBLIC, PRIVATE)
- maxParticipants: Integer (nullable, null=무제한)
- createdAt: LocalDateTime (not null)
- createdBy: Long (생성자 user id)

// ChatRoomParticipant (참여자)
- id: Long (PK, Auto Increment)
- roomId: Long (FK → ChatRoom)
- userId: Long (FK → User)
- joinedAt: LocalDateTime (not null)
- Unique Key: (roomId, userId) - 중복 참여 방지

// ChatMessage (메시지)
- id: Long (PK, Auto Increment)
- roomId: Long (FK → ChatRoom, indexed)
- senderId: Long (FK → User)
- content: String (not null)
- messageType: MessageType (enum: TEXT, IMAGE, SYSTEM)
- sentAt: LocalDateTime (not null, indexed)
- Index: (roomId, sentAt) - 메시지 조회 성능
```

### Enum 정의


```java
public enum RoomType {
    PUBLIC,   // 공개방
    PRIVATE   // 비공개방
}

public enum MessageType {
    TEXT,     // 일반 텍스트
    IMAGE,    // 이미지 (URL)
    SYSTEM    // 시스템 메시지 (입장/퇴장)
}
```


## 5. API 설계

### REST API 엔드포인트
```
GET    /api/rooms                    - 전체 방 목록 조회
POST   /api/rooms                    - 방 생성
GET    /api/rooms/{roomId}           - 방 상세 조회
POST   /api/rooms/{roomId}/join      - 방 참여
DELETE /api/rooms/{roomId}/leave     - 방 나가기 (Phase 3)
GET    /api/rooms/my                 - 내가 참여한 방 목록
GET    /api/rooms/{roomId}/messages  - 메시지 조회 (페이징)

헤더: userId (Long) - 임시 인증 (나중에 JWT로 교체)


### REST API Request/Response DTO

#### 방 생성 요청

json

```json
POST /api/rooms
{
  "name": "자유 채팅방",
  "type": "PUBLIC",
  "maxParticipants": 50
}
```

#### 방 목록 응답

json

```json
GET /api/rooms
{
  "rooms": [
    {
      "id": 1,
      "name": "자유 채팅방",
      "type": "PUBLIC",
      "participantCount": 15,
      "maxParticipants": 50,
      "createdAt": "2024-01-01T10:00:00"
    }
  ]
}
```

#### 메시지 조회 응답

json

````json
GET /api/rooms/1/messages?page=0&size=50
{
  "messages": [
    {
      "id": 100,
      "senderId": 5,
      "senderNickname": "철수",
      "content": "안녕하세요!",
      "messageType": "TEXT",
      "sentAt": "2024-01-01T10:05:00"
    }
  ],
  "hasNext": true
}
```

### WebSocket 엔드포인트
```
연결: ws://localhost:8080/ws
구독: /topic/room/{roomId}
발행: /app/chat.sendMessage/{roomId}

발행 메시지 형식:
{
  "content": "안녕하세요!",
  "messageType": "TEXT"
}

헤더에 userId 필수 포함
```

## 6. 프로젝트 구조
```
src/main/java/com/example/chat/
├── domain/
│   ├── user/
│   │   ├── User.java                    (Entity)
│   │   ├── UserRepository.java          (JPA Repository)
│   │   └── UserService.java             (비즈니스 로직)
│   ├── room/
│   │   ├── ChatRoom.java                (Entity)
│   │   ├── ChatRoomRepository.java
│   │   ├── ChatRoomService.java
│   │   ├── ChatRoomParticipant.java     (Entity)
│   │   └── ChatRoomParticipantRepository.java
│   └── message/
│       ├── ChatMessage.java             (Entity)
│       ├── ChatMessageRepository.java
│       └── ChatMessageService.java
├── api/
│   ├── RoomController.java              (REST API)
│   └── MessageController.java           (WebSocket)
├── dto/
│   ├── request/
│   │   ├── CreateRoomRequest.java
│   │   ├── JoinRoomRequest.java
│   │   └── ChatMessageRequest.java
│   └── response/
│       ├── RoomResponse.java
│       ├── RoomListResponse.java
│       └── MessageResponse.java
├── config/
│   ├── WebSocketConfig.java            (WebSocket 설정)
│   └── RedisConfig.java                 (Redis Pub/Sub 설정)
├── redis/
│   ├── RedisPublisher.java              (메시지 발행)
│   └── RedisSubscriber.java             (메시지 구독)
├── exception/
│   ├── GlobalExceptionHandler.java
│   └── BusinessException.java
└── ChatApplication.java
```

## 7. Redis 아키텍처

### 메시지 플로우
```
1. 클라이언트 A가 메시지 전송 (WebSocket)
   ↓
2. Spring Boot 서버가 수신
   ↓
3. PostgreSQL에 메시지 저장
   ↓
4. Redis Pub/Sub에 메시지 발행 (topic: "chat:room:{roomId}")
   ↓
5. 모든 서버 인스턴스가 구독하여 수신
   ↓
6. 각 서버가 자신의 WebSocket 클라이언트들에게 브로드캐스트
```

### Redis 채널 네이밍
```
chat:room:{roomId}  - 방별 메시지 채널
예: chat:room:1, chat:room:2
````

## 8. 의존성 (build.gradle)

gradle

```gradle
dependencies {
    // Spring Boot
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-websocket'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    
    // Database
    runtimeOnly 'org.postgresql:postgresql'
    
    // JSON
    implementation 'com.fasterxml.jackson.core:jackson-databind'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'
    
    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
}
```

## 9. 설정 파일 (application.yml)

yaml

```yaml
spring:
  application:
    name: chat-service
    
  datasource:
    url: jdbc:postgresql://localhost:5432/chatdb
    username: postgres
    password: password
    driver-class-name: org.postgresql.Driver
    
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        
  data:
    redis:
      host: localhost
      port: 6379

server:
  port: 8080

logging:
  level:
    com.example.chat: DEBUG
    org.springframework.web.socket: DEBUG
```

## 10. 코딩 컨벤션

- **패키지명**: 소문자, 단수형
- **클래스명**: PascalCase
- **메서드/변수명**: camelCase
- **상수**: UPPER_SNAKE_CASE
- **DTO 네이밍**: ~Request, ~Response
- **예외 네이밍**: ~Exception
- **Lombok 적극 활용**:
    - @Getter, @NoArgsConstructor, @AllArgsConstructor
    - @Builder (엔티티 생성자 대신)
    - @Slf4j (로깅)

## 11. 개발 우선순위

### Step 1: 엔티티 계층 (가장 먼저)

1. User 엔티티 + Repository
2. ChatRoom 엔티티 + Repository
3. ChatRoomParticipant 엔티티 + Repository
4. ChatMessage 엔티티 + Repository

### Step 2: 서비스 계층

1. UserService (간단한 CRUD)
2. ChatRoomService (방 생성, 조회, 참여)
3. ChatMessageService (메시지 저장, 조회)

### Step 3: REST API

1. RoomController (방 관련 API)
2. DTO 작성

### Step 4: WebSocket + Redis

1. WebSocketConfig 설정
2. RedisConfig 설정
3. RedisPublisher, RedisSubscriber 구현
4. MessageController (WebSocket)

## 12. 주요 요구사항

### 예외 처리

- GlobalExceptionHandler로 일관된 예외 응답
- 커스텀 예외: RoomNotFoundException, UserNotFoundException 등
- 응답 형식:

json

```json
{
  "error": "ROOM_NOT_FOUND",
  "message": "존재하지 않는 방입니다.",
  "timestamp": "2024-01-01T10:00:00"
}
```

### Validation

- @Valid, @NotNull, @NotBlank, @Size 등 적극 활용
- DTO에 validation 적용

### 트랜잭션

- Service 계층에 @Transactional 적용
- 읽기 전용: @Transactional(readOnly = true)

### 로깅

- 중요 로직에 로그 추가 (SLF4J)
- 로그 레벨: ERROR, WARN, INFO, DEBUG

## 13. 개발 시 주의사항

### 점진적 개발

- **한 번에 하나씩**: 엔티티 → Repository → Service → Controller
- **단계별 테스트**: 각 단계 완료 후 동작 확인
- **커밋 단위**: 기능별로 작게 나누어 커밋

### 코드 품질

- 각 클래스/메서드에 간단한 JavaDoc 주석
- 매직 넘버/문자열 상수화
- 코드 중복 최소화

### 테스트

- Phase 1에서는 수동 테스트 (Postman, WebSocket 클라이언트)
- 단위 테스트는 Phase 2 이후 추가

## 14. 제약사항 및 간소화

### 현재 단계에서 제외

- ❌ 인증/인가 (JWT, Spring Security)
    - 헤더에 userId만 전달
- ❌ 프론트엔드
    - Postman, WebSocket 클라이언트로 테스트
- ❌ 성능 최적화
    - 일단 동작하는 코드 우선
- ❌ 배포 설정
    - 로컬 개발 환경만

### 나중에 추가할 기능

- 안읽은 메시지 카운트
- 메시지 수정/삭제
- 파일 업로드 (이미지)
- 타이핑 인디케이터
- 온라인 상태 표시

## 15. Docker 설정 (참고용)

### docker-compose.yml

yaml

````yaml
version: '3.8'
services:
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: chatdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

실행: `docker-compose up -d`

## 16. 개발 시작 시 질문 사항

Claude Code에게 이렇게 요청하세요:
```
"Phase 1의 Step 1부터 시작해줘. 
먼저 User 엔티티와 UserRepository를 만들어줘.
엔티티 설계는 위 가이드 문서의 4번 항목을 참고해줘.
완료되면 다음 단계로 진행할지 물어봐줘."
````

## 17. 자주 발생할 수 있는 이슈

### WebSocket CORS 문제

- WebSocketConfig에서 setAllowedOrigins("*") 설정 필요

### Redis 연결 실패

- Redis가 실행 중인지 확인
- application.yml의 host/port 확인

### JPA N+1 문제

- 일단은 무시, Phase 2에서 fetch join으로 해결

---